---
title: "Compare AD signatures"
subtitle: 'PsychAD vs Mathys, et al'
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
---


<!---

cd /Users/gabrielhoffman/workspace/repos/heivr_analysis

cd ~/work/heivr_analysis

# rm -rf cmc_cache

ml git
ml gcc/11.2.0
R

system("git pull"); rmarkdown::render("PsychAD_Mathys.Rmd");

https://hoffmg01.u.hpc.mssm.edu/work/heivr_analysis/PsychAD_Mathys.html


--->



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  dev = c("png", "pdf"),
  cache = TRUE,
  package.startup.message = FALSE,
  cache.lazy = FALSE)
```

```{r load, cache=FALSE}
library(dreamlet)
library(heivr)
library(tidyverse)
library(Matrix)
library(ggcorrplot)
library(progress)
```

```{r read.data}
file = "/sc/arion/projects/CommonMind/hoffman/dreamlet_analysis/PsychAD_r0/PsychAD_dreamlet.RDS"
# file = "~/Downloads/PsychAD_dreamlet.RDS"
fit.psychad = readRDS(file)
tab.psychad = topTable(fit.psychad, coef="DxAD", number=Inf) %>%
                as_tibble %>%
                mutate(se = logFC / t)

file = "/sc/arion/projects/CommonMind/hoffman/eval_methods/dreamlet/Mathys_dreamlet.RDS"
# file = "~/Downloads/Mathys_dreamlet.RDS"
fit.mathys = readRDS(file)
tab.mathys = topTable(fit.mathys, coef="educ", number=Inf) %>%
                as_tibble %>%
                mutate(se = logFC / t)
```

```{r analysis, fig.height=8}
# Compare Astrocytes
pair = c(psychad = "Astro", mathys = "Ast")

tab.psychad.sub = tab.psychad %>% 
        filter(assay == pair[['psychad']])

tab.mathys.sub = tab.mathys %>% 
        filter(assay == pair[['mathys']])

tab = inner_join(tab.psychad.sub, tab.mathys.sub, by="ID")

hobj.mle = with(tab, heivr(logFC.x, logFC.y, se.x^2, se.y^2))
hobj.mle


lim = max(abs(c(hobj.mle$x, hobj.mle$y)))
lim = c(-lim, lim)
plot(hobj.mle, xlab="logFC (PsychAD)", ylab="logFC (Mathys)", main="Astrocytes", xlim=lim, ylim=lim)
abline(0,1)
abline(h=0, lty=3)
abline(v=0, lty=3)  

# Permuted data
i = sample.int(nrow(tab), nrow(tab))
hobj.mle2 = with(tab, heivr(logFC.x[i], logFC.y, se.x[i]^2, se.y^2))
hobj.mle2

lim = max(abs(c(hobj.mle2$x, hobj.mle2$y)))
lim = c(-lim, lim)
plot(hobj.mle2, xlab="logFC (PsychAD)", ylab="logFC (Mathys)", main="Astrocytes: permuted", xlim=lim, ylim=lim)
abline(0,1)
abline(h=0, lty=3)
abline(v=0, lty=3)
```

fit = with(tab.psychad.sub, metafor::rma(yi=logFC, sei=se))


# All pairs
```{r all}
heivrMatrix = function( tab ){

  tab$se = with(tab, logFC / t)

  cellTypes = unique(tab$assay)

  grd = t(combn(length(cellTypes), 2))
  grd = data.frame( CT1 = cellTypes[grd[,1,drop=TRUE]], 
                    CT2 = cellTypes[grd[,2,drop=TRUE]])

  pb <- progress_bar$new(total = nrow(grd), format = " [:bar] :percent eta: :eta", clear = TRUE, width= 60)

  df = lapply( seq(nrow(grd)), function(i){

    tab.sub1 = tab %>% 
            filter(assay == grd$CT1[i])

    tab.sub2 = tab %>% 
            filter(assay == grd$CT2[i])

    tab.join = inner_join(tab.sub1, tab.sub2, by="ID")

    df = list()
    df$cor = with(tab.join, cor(logFC.x, logFC.y))

    hobj.mle = with(tab.join, heivr(logFC.x, logFC.y, se.x^2, se.y^2))
    df$cor.heivr = hobj.mle$rho
    df$cor.heivr.se = hobj.mle$rho.se
    df$p.value = hobj.mle$p.value

    pb$tick()

    data.frame(CT1 = grd$CT1[i], CT2 = grd$CT2[i], df)
  })
  df = do.call(rbind, df)

  pb$terminate()

  df
}

convertToMatrix = function(df, column){

  df$i = factor(df$CT1, cellTypes)
  df$j = factor(df$CT2, cellTypes)

  C = sparseMatrix(i = as.numeric(df$i), 
                          j = as.numeric(df$j), 
                          x = df[[column]], 
                          symmetric = TRUE)
  rownames(C) = cellTypes
  colnames(C) = cellTypes
  diag(C) = 1

  as.matrix(C)
}


# Mathys
res.Mathys = heivrMatrix(tab.mathys)

# PsychAD
# res.PsychAD = heivrMatrix(tab.psychad)

# # merged
# tab.merge = rbind(tab.mathys %>% mutate(assay = paste0('Mathys.', assay)),
#   tab.psychad %>% mutate(assay = paste0('PsychAD.', assay)))

# res.merge = heivrMatrix(tab.merge)
```

# Mathys
```{r plots.Mathys}
C = convertToMatrix(res.Mathys, "cor")
ggcorrplot(C, method = "circle",hc.order = TRUE)

C = convertToMatrix(res.Mathys, "cor.heivr")
ggcorrplot(C, method = "circle", hc.order = TRUE)
```

# PsychAD
```{r plots.PsychAD, fig.height=10, fig.width=10, eval=FALSE}
ggcorrplot(res.PsychAD$C.pearson, method = "circle",hc.order = TRUE)
ggcorrplot(res.PsychAD$C.heivr, method = "circle", hc.order = TRUE)
```


pair = c(psychad = "Micro_PVM", mathys = "Mic")

tab.psychad.sub = tab.psychad %>% 
        filter(assay == pair[['psychad']])

tab.mathys.sub = tab.mathys %>% 
        filter(assay == pair[['mathys']])

tab = inner_join(tab.psychad.sub, tab.mathys.sub, by="ID")

hobj.mle = with(tab, heivr(logFC.x, logFC.y, se.x^2, se.y^2))
hobj.mle


lim = max(abs(c(hobj.mle$x, hobj.mle$y)))
lim = c(-lim, lim)
plot(hobj.mle, xlab="logFC (PsychAD)", ylab="logFC (Mathys)", main="Astrocytes", xlim=lim, ylim=lim)
abline(0,1)
abline(h=0, lty=3)
abline(v=0, lty=3)  







# Merge
```{r plots.merge, fig.height=12, fig.width=12, eval=FALSE}
ggcorrplot(res.merge$C.pearson, method = "circle",hc.order = TRUE)
ggcorrplot(res.merge$C.heivr, method = "circle", hc.order = TRUE)
```


















# PsychAD: all pairs
```{r all.pairs, eval=FALSE, echo=FALSE}
grd = expand.grid(CT1 = unique(tab.psychad$assay), 
                  CT2 = unique(tab.mathys$assay))

df = lapply( seq(nrow(grd)), function(i){
  message(i)

  tab.sub1 = tab.psychad %>% 
          filter(assay == grd$CT1[i])

  tab.sub2 = tab.mathys %>% 
          filter(assay == grd$CT2[i])

  tab = inner_join(tab.sub1, tab.sub2, by="ID")

  df = list()
  df$cor = with(tab, cor(logFC.x, logFC.y))

  hobj.mle = with(tab, heivr(logFC.x, logFC.y, se.x^2, se.y^2, LRT=FALSE))
  df$cor.heivr = hobj.mle$rho
  df$cor.heivr.se = hobj.mle$rho.se

  data.frame(CT1 = grd$CT1[i], CT2 = grd$CT2[i], df)
})
df = do.call(rbind, df)

df$i = factor(df$CT1)
df$j = factor(df$CT2)


C.pearson = sparseMatrix(i = as.numeric(df$i), 
                j = as.numeric(df$j), x = df$cor )
rownames(C.pearson) = CT
colnames(C.pearson) = CT



C.heivr = sparseMatrix(i = as.numeric(df$i), 
                j = as.numeric(df$j), x = df$cor.heivr )
rownames(C.heivr) = CT
colnames(C.heivr) = CT

library(ggcorrplot)


ggcorrplot(as.matrix(C.pearson), method = "circle",hc.order = TRUE)
ggcorrplot(as.matrix(C.heivr), method = "circle", hc.order = TRUE)




```









